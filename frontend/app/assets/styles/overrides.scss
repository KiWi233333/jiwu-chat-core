/**
 * 样式重写
 * 包含：Element Plus，动画，以及外部库（Markdown、右键菜单、NProgress）
 */

/* ==========================================================================
   变量
   ========================================================================== */

// 动画配置
$popup-animation-duration: 0.22s;
$popup-animation-timing: var(--animate-cubic);
$popup-scale-from: 0.96;
$popover-animation-duration: 0.16s;
$popover-animation-timing: ease;
$drawer-animation-duration: 0.5s;
$drawer-animation-timing: cubic-bezier(0.32, 0.72, 0, 1);

/* ==========================================================================
   Element Plus 覆盖
   ========================================================================== */

/* --- 基础 --- */

// 按钮
.el-button {
  transition: $transition-delay;
}

// 遮罩层
.el-overlay {
  border-radius: 0.3rem;
}

/* --- 表单组件 --- */

// 输入框
.el-input {
  &.input-weak {
    .el-input__wrapper {
      box-shadow: none;
      --at-apply: "input-bg-color";
    }
  }
}

// 无边框输入组件（去除所有边框、阴影、outline）
.el-borderless {
  --el-border: none !important;
  --el-border-color: transparent !important;
  --el-border-radius: 0 !important;
  --el-box-shadow: none !important;
  --el-input-border-color: transparent !important;
  .el-checkbox__inner,
  .el-radio__inner,
  .el-input__inner,
  .el-textarea__inner,
  .el-input__wrapper,
  .el-select__wrapper,
  &.el-select .el-input__wrapper {
    border-color: transparent !important;
    box-shadow: none !important;
    --at-apply: "bg-color-2";

    &:hover,
    &:focus-visible,
    &:focus-within,
    &:focus-within:hover,
    &.disabled,
    &.is-focus {
      border-color: transparent !important;
      box-shadow: none !important;
      outline: none !important;
    }
  }
}

// 单选框组
.el-radio-group {
  font-size: medium;
  .el-radio__inner {
    border-radius: 4px;
    transform: scale(1.1);
  }
}

// 表单项
.el-form-item {
  .el-form-item__error {
    margin-top: 0.1em;
  }
}

// 自动补全
.el-popper.el-autocomplete__popper {
  --at-apply: "p-0 rounded-10px border-default";
  .el-autocomplete-suggestion {
    padding: 0.5em;
  }
  .el-scrollbar {
    .el-autocomplete-suggestion__wrap {
      padding: 0;
    }
    .el-scrollbar__view.el-autocomplete-suggestion__list {
      padding: 0;
    }
  }
  .el-autocomplete-suggestion__list li {
    --el-mention-option-hover-background: #958c9b44;
    padding: 0.5em;
    border-radius: calc(var(--el-border-radius-base) - 2px);
  }
}

// 选择框 / 提及 / 自动补全
.el-popper.el-mention__popper,
.el-popper.el-picker__popper,
.el-popper.el-color-picker__panel,
.el-popper.el-select__popper {
  --at-apply: "!bg-white overflow-hidden !dark:(bg-dark-8 bg-op-70) !bg-op-80 !backdrop-blur-6 rounded-10px border-default-3";
  .el-select-dropdown,
  .el-mention-dropdown {
    .el-select-dropdown__footer {
      --at-apply: "p-0 pt-1.5 border-default-2-t";
    }
    .el-scrollbar {
      padding: 0.5em;
    }
  }

  .el-popper__arrow::before {
    --at-apply: "!bg-white  !bg-op-80 !dark:(bg-dark-8 bg-op-50) !backdrop-blur-6 border-default-3";
  }
  .el-scrollbar {
    .el-scrollbar__wrap {
      padding: 0;
    }
    .el-scrollbar__view.el-mention-dropdown__list {
      padding: 0;
    }
    .el-scrollbar__bar {
      opacity: 0.5;
    }
    .el-select-dropdown__list {
      padding: 0;
    }
  }
  .el-select-dropdown__item,
  .el-mention-dropdown__item {
    --el-fill-color-light: #958c9b1f;
    --el-mention-option-hover-background: #958c9b1f;
    padding: 0 1em;
    border-radius: calc(var(--el-border-radius-base) - 2px);
  }
}
.el-cascader-panel {
  .el-scrollbar__view.el-cascader-menu__list {
    padding: 0.5em;

    .el-cascader-node {
      border-radius: calc(var(--el-border-radius-base) - 2px);
    }
  }
}

// 日期选择器
.el-picker-panel {
  --at-apply: "card-rounded-df overflow-hidden";
}

/* --- 导航 & 数据 --- */

// 下拉菜单
.el-dropdown-menu {
  .el-dropdown-menu__item {
    --at-apply: "h-fit mx-1 transition-100 rounded-1";
    &:not(.is-disabled) {
      &:hover,
      &:focus {
        --at-apply: "bg-theme-primary text-white shadow";
      }
    }
  }
  .el-dropdown-menu__item--divided {
    --at-apply: "border-default-t";
  }
}

.el-dropdown__popper {
  --at-apply: "!border-default-hover";
}

/* --- 分割线 --- */
.el-divider {
  .el-divider__text {
    --at-apply: "card-rounded-df leading-[1.5]";
  }
}

/* --- 反馈 & 遮罩 --- */

// 消息弹框
.el-message-box {
  --at-apply: "border-default-sm";
  .el-message-box__header {
    padding: 0 !important;
    font-size: 2em;
    text-align: center;
    letter-spacing: 0.1em;
  }
  .el-message-box__headerbtn {
    display: none;
    top: 10px;
    right: 10px;
  }
  .el-message-box__btns {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin: 0;

    .el-button {
      min-width: 46%;
      height: auto;
    }
    .el-button:first-child {
      margin-right: auto;
    }
  }

  .el-message-box__content {
    font-size: 0.9rem;
    margin-top: 1rem;
  }

  .el-message-box__title {
    font-size: 1rem;
  }
}

.el-overlay.is-message-box {
  .el-message-box {
    box-shadow:
      rgba(0, 0, 0, 0.05) 0px 7px 29px 0px,
      rgba(0, 0, 0, 0.05) 0px 3px 18px 0px;
  }
}

// 消息提示
body .el-message {
  --at-apply: "text-5 w-90vw max-w-90vw px-4 py-3 shadow-sm items-center sm:(w-fit max-w-20em px-2 text-3.8  pr-4 py-1.5 rounded-2rem shadow-sm)";
  .el-message__content {
    --at-apply: "truncate text-3.4";
  }
}

// 对话框
.el-dialog {
  --at-apply: "border-default-sm";
  .el-dialog__headerbtn {
    height: 54px;
  }
  .el-dialog__title {
    font-size: 1rem;
  }
  .el-dialog__header.show-close {
    padding-left: 0;
    padding-right: 0;
  }
}

// 抽屉
.el-drawer {
  transition-duration: $drawer-animation-duration;
  transition-timing-function: $drawer-animation-timing;
}

// Popper 通用类
.el-popper-init {
  padding: 2px 4px;
}

// 加载遮罩
.el-loading-mask {
  background-color: rgba(0, 0, 0, 0.1);
  -webkit-backdrop-filter: blur(6px);
  backdrop-filter: blur(6px);
  border-radius: calc(var(--el-border-radius-base) - 2px);

  *.is-fullscreen {
    border-radius: calc(var(--el-border-radius-base) - 2px);
  }

  .el-loading-spinner {
    .circular {
      animation-duration: 2s;
    }
    .el-loading-text {
      color: var(--el-color-base) !important;
    }
  }
}

.dark {
  .el-loading-mask {
    background-color: rgba(0, 0, 0, 0.2);
    -webkit-backdrop-filter: blur(6px);
    backdrop-filter: blur(6px);
  }
}

// 小尺寸屏幕（默认隐藏滚动条）
@media screen and (max-width: 640px) {
  .el-scrollbar {
    .el-scrollbar__bar {
      display: none;
    }
  }

  // 隐藏滚动条
  html,
  body {
    &::-webkit-scrollbar {
      display: none;
    }
    &::-webkit-scrollbar-track {
      background-color: transparent;
    }
    &::-webkit-scrollbar-thumb {
      background-color: transparent;
    }
  }
  // overflow-y-auto
  .overflow-y-auto {
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    &::-webkit-scrollbar {
      display: none;
    }
    &::-webkit-scrollbar-track {
      background-color: transparent;
    }
  }
}

// 图片预览
.el-image-viewer__wrapper {
  border-radius: calc(var(--el-border-radius-base) - 2px);
  overflow: hidden;
  .el-image-viewer__close {
    --at-apply: "!card-default-br";
  }
  .el-image-viewer__actions {
    height: 2.4em !important;
    --at-apply: "py-2 bg-color-br rounded-2rem op-80 hover:op-100 h-fit transition-all";
  }
  .el-image-viewer__mask {
    background-color: rgba(0, 0, 0, 0.2);
    opacity: 1;
  }
}

.el-image-viewer__wrapper:focus {
  animation: none;
  .el-image-viewer__canvas {
    animation: none;
  }
}

// 分段器
.el-segmented {
  --at-apply: "p-1 shadow-sm shadow-inset bg-[#fafafa] dark:bg-[#1b1b1b]";

  .el-segmented__item {
    font-size: 0.95em; // 选项字体略小
  }
  .el-segmented__item-selected {
    --at-apply: "shadow-sm hover:shadow bg-white dark:bg-dark-3";
  }
}

/* ==========================================================================
   外部库样式重写
   ========================================================================== */

/* --- Markdown 编辑器 --- */
.md-editor-preview {
  a {
    &:hover {
      border: none !important;
    }
    &::after {
      display: none !important;
    }
  }
}

/* --- 右键菜单 (mx-context-menu) --- */
.mx-context-menu {
  --popper-fade-anima-scale: 0.9;
  transform-origin: center top;
  --at-apply: "!border-none dark:!bg-[#22222299] backdrop-blur-6 !bg-[#ffffff99] animate-[popper-fade-anim_0.15s]";

  .mx-context-menu-items {
    .mx-context-menu-item {
      .mx-item-row {
        --at-apply: "text-color";
        margin: 4px 2px;
      }
      &:hover .mx-item-row {
        --at-apply: "text-white";
      }
    }
  }

  .mx-context-menu-item-sperator {
    --mx-menu-divider: rgba(132, 132, 132, 0.2);
    background-color: transparent;
  }

  .mx-icon-placeholder {
    i {
      font-size: 0.9em;
      transition: transform 0.2s;
    }
  }

  .mx-context-menu-item {
    --mx-menu-active-backgroud: var(--el-color-primary);
    --mx-menu-hover-backgroud: var(--el-color-primary);
    --mx-menu-open-hover-backgroud: var(--el-color-primary);
    --mx-menu-open-backgroud: #71717188;

    &:hover {
      .mx-icon-placeholder {
        i {
          --at-apply: "light:text-light";
        }
      }
    }
  }
}
.dark {
  .mx-context-menu {
    .mx-context-menu-item {
      --mx-menu-active-backgroud: #ffffff1a;
      --mx-menu-hover-backgroud: #ffffff1a;
      --mx-menu-open-hover-backgroud: #7b7b7b10;
      --mx-menu-open-backgroud: #7b7b7b10;
    }
  }
}

/* --- NProgress 进度条 --- */
#nprogress .bar {
  height: 3px;
  background: $loading-color2 !important;
}

.dark #nprogress .bar {
  height: 3px;
  background: $loading-color-dark2 !important;
}

/* ==========================================================================
   动画
   ========================================================================== */

// 1. 对话框与遮罩淡入淡出
.el-modal-dialog.dialog-fade-enter-active,
.el-modal-dialog.dialog-fade-leave-active,
.el-overlay.dialog-fade-enter-active,
.el-overlay.dialog-fade-leave-active {
  transition: opacity $popup-animation-duration $popup-animation-timing !important;
  user-select: none;

  .el-overlay-dialog {
    animation: none !important;
    transform: none !important;
  }

  .el-dialog {
    transition:
      transform $popup-animation-duration $popup-animation-timing,
      opacity $popup-animation-duration $popup-animation-timing !important;
  }
}

.el-modal-dialog.dialog-fade-enter-from,
.el-modal-dialog.dialog-fade-leave-to,
.el-overlay.dialog-fade-enter-from,
.el-overlay.dialog-fade-leave-to {
  opacity: 0;

  .el-overlay-dialog {
    animation: none !important;
    transform: none !important;
  }

  .el-dialog {
    opacity: 0;
    transform: scale3d($popup-scale-from, $popup-scale-from, 1);
  }
}

.el-modal-dialog.dialog-fade-enter-to,
.el-modal-dialog.dialog-fade-leave-from,
.el-overlay.dialog-fade-enter-to,
.el-overlay.dialog-fade-leave-from {
  opacity: 1;

  .el-dialog {
    opacity: 1;
    transform: scale3d(1, 1, 1);
  }
}

// 2. 消息框淡入淡出
.el-overlay.is-message-box {
  &.fade-in-linear-enter-active,
  &.fade-in-linear-leave-active {
    transition: opacity $popup-animation-duration $popup-animation-timing !important;
    user-select: none;

    .el-overlay-message-box {
      animation: none !important;
      transform: none !important;
    }

    .el-message-box {
      transition:
        transform $popup-animation-duration $popup-animation-timing,
        opacity $popup-animation-duration $popup-animation-timing !important;
    }
  }

  &.fade-in-linear-enter-from,
  &.fade-in-linear-leave-to {
    opacity: 0;

    .el-overlay-message-box {
      animation: none !important;
      transform: none !important;
    }

    .el-message-box {
      opacity: 0;
      transform: scale3d($popup-scale-from, $popup-scale-from, 1);
    }
  }

  &.fade-in-linear-enter-to,
  &.fade-in-linear-leave-from {
    opacity: 1;

    .el-message-box {
      opacity: 1;
      transform: scale3d(1, 1, 1);
    }
  }
}

// 3. Tooltip/Popper 缩放动画
$popper-placements: (
  "bottom": (
    center top,
    translateY(-4px),
  ),
  "bottom-end": (
    center top,
    translateY(-4px),
  ),
  "bottom-start": (
    center top,
    translateY(-4px),
  ),
  "top": (
    center bottom,
    translateY(4px),
  ),
  "top-end": (
    center bottom,
    translateY(4px),
  ),
  "top-start": (
    center bottom,
    translateY(4px),
  ),
  "left": (
    right center,
    translateX(4px),
  ),
  "left-start": (
    right center,
    translateX(4px),
  ),
  "left-end": (
    right center,
    translateX(4px),
  ),
  "right": (
    left center,
    translateX(-4px),
  ),
  "right-start": (
    left center,
    translateX(-4px),
  ),
  "right-end": (
    left center,
    translateX(-4px),
  ),
);

$zoom-classes: (el-zoom-in-top, el-zoom-in-bottom, el-zoom-in-left, el-zoom-in-right, el-fade-in-linear);

@each $placement, $config in $popper-placements {
  $origin: nth($config, 1);
  $translate: nth($config, 2);

  [data-popper-placement="#{$placement}"] {
    transform-origin: #{$origin};

    &.el-popper:not(.item-animate-wave, .el-mention__popper) {
      @each $class in $zoom-classes {
        &.#{$class}-enter-active,
        &.#{$class}-leave-active {
          transition:
            opacity $popover-animation-duration $popover-animation-timing,
            transform $popover-animation-duration $popover-animation-timing;
        }

        &.#{$class}-enter-to,
        &.#{$class}-leave-from {
          opacity: 1;
          transform: translateX(0) translateY(0) scale3d(1, 1, 1);
        }

        &.#{$class}-enter-from,
        &.#{$class}-leave-to {
          opacity: 0;
          transform: #{$translate} scale3d($popup-scale-from, $popup-scale-from, 1);
        }
      }
    }
  }
}

@each $class in $zoom-classes {
  .el-popper:not(.item-animate-wave, .el-mention__popper) {
    &.#{$class}-enter-active,
    &.#{$class}-leave-active {
      transition:
        opacity $popover-animation-duration $popover-animation-timing,
        transform $popover-animation-duration $popover-animation-timing;
    }

    &.#{$class}-enter-to,
    &.#{$class}-leave-from {
      opacity: 1;
      transform: translateX(0) translateY(0) scale3d(1, 1, 1);
    }
  }
}

// 独立缩放动画
.el-zoom-in-center-enter-active,
.el-zoom-in-center-leave-active {
  transition:
    opacity $popover-animation-duration $popover-animation-timing,
    transform $popover-animation-duration $popover-animation-timing;
}

.el-zoom-in-center-enter-from,
.el-zoom-in-center-leave-to {
  opacity: 0;
  transform: scale3d($popup-scale-from, $popup-scale-from, 1);
}

.el-zoom-in-center-enter-to,
.el-zoom-in-center-leave-from {
  opacity: 1;
  transform: scale3d(1, 1, 1);
}

.el-zoom-in-top-enter-active,
.el-zoom-in-top-leave-active {
  transition:
    opacity $popover-animation-duration $popover-animation-timing,
    transform $popover-animation-duration $popover-animation-timing;
  transform-origin: center top;
}

.el-zoom-in-top-enter-from,
.el-zoom-in-top-leave-to {
  opacity: 0;
  transform: translateY(-1%) scale3d($popup-scale-from, $popup-scale-from, 1);
}

.el-zoom-in-top-enter-to,
.el-zoom-in-top-leave-from {
  opacity: 1;
  transform: translateY(0) scale3d(1, 1, 1);
}

.el-zoom-in-bottom-enter-active,
.el-zoom-in-bottom-leave-active {
  transition:
    opacity $popover-animation-duration $popover-animation-timing,
    transform $popover-animation-duration $popover-animation-timing;
  transform-origin: center bottom;
}

.el-zoom-in-bottom-enter-from,
.el-zoom-in-bottom-leave-to {
  opacity: 0;
  transform: translateY(1%) scale3d($popup-scale-from, $popup-scale-from, 1);
}

.el-zoom-in-bottom-enter-to,
.el-zoom-in-bottom-leave-from {
  opacity: 1;
  transform: translateY(0) scale3d(1, 1, 1);
}

.el-zoom-in-left-enter-active,
.el-zoom-in-left-leave-active {
  transition:
    opacity $popover-animation-duration $popover-animation-timing,
    transform $popover-animation-duration $popover-animation-timing;
  transform-origin: left center;
}

.el-zoom-in-left-enter-from,
.el-zoom-in-left-leave-to {
  opacity: 0;
  transform: translateX(-1%) scale3d($popup-scale-from, $popup-scale-from, 1);
}

.el-zoom-in-left-enter-to,
.el-zoom-in-left-leave-from {
  opacity: 1;
  transform: translateX(0) scale3d(1, 1, 1);
}

.el-zoom-in-right-enter-active,
.el-zoom-in-right-leave-active {
  transition:
    opacity $popover-animation-duration $popover-animation-timing,
    transform $popover-animation-duration $popover-animation-timing;
  transform-origin: right center;
}

.el-zoom-in-right-enter-from,
.el-zoom-in-right-leave-to {
  opacity: 0;
  transform: translateX(1%) scale3d($popup-scale-from, $popup-scale-from, 1);
}

.el-zoom-in-right-enter-to,
.el-zoom-in-right-leave-from {
  opacity: 1;
  transform: translateX(0) scale3d(1, 1, 1);
}
