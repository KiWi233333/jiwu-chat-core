# 极物圈 API 使用说明

## 环境要求

- **JDK**: 21+
- **Maven**: 3.8+
- **MySQL**: 8.0+
- **Redis**: 6.0+
- **RabbitMQ**: 3.11+（可选，需安装延迟队列插件）

### 使用 Homebrew 安装（macOS 推荐）

```bash
# 一、安装 JDK 21
brew install openjdk@21
brew link --overwrite openjdk@21

# 二、安装 Maven
brew install maven

# 三、安装 MySQL
brew install mysql
brew services start mysql

# 四、安装 Redis
brew install redis
brew services start redis

# 五、安装 RabbitMQ（需安装延迟队列插件）
brew install rabbitmq
brew services start rabbitmq

# 六、安装 RabbitMQ 延迟队列插件（必须）
# 1. 安装 jq（用于解析 JSON）
brew install jq

# 2. 获取插件下载地址并安装
RABBITMQ_PREFIX=$(brew --prefix rabbitmq)
RABBITMQ_PLUGINS_DIR="${RABBITMQ_PREFIX}/plugins"
PLUGIN_URL=$(curl -s "https://api.github.com/repos/rabbitmq/rabbitmq-delayed-message-exchange/releases/latest" | jq -r '.assets[] | select(.name | endswith(".ez")) | .browser_download_url')
PLUGIN_FILE=$(basename "$PLUGIN_URL")
curl -L -o "$PLUGIN_FILE" "$PLUGIN_URL"
mv "$PLUGIN_FILE" "$RABBITMQ_PLUGINS_DIR/"

# 3. 启用延迟队列插件
"${RABBITMQ_PREFIX}/sbin/rabbitmq-plugins" enable rabbitmq_delayed_message_exchange

# 4. 重启 RabbitMQ 使插件生效
brew services restart rabbitmq
```

> **提示**：项目提供了自动化安装脚本，可直接运行 `./script/install_brew_services.sh` 一键安装所有服务。

## 快速开始

### 1. 克隆项目

```bash
git clone https://github.com/Kiwi233333/jiwu-chat-api.git
cd jiwu-chat-api
```

### 2. 初始化数据库

#### 方式一：使用脚本（推荐）

```bash
# 进入脚本目录
cd script

# 运行初始化脚本（交互式）
./init_db_local.sh

# 或指定环境
./init_db_local.sh -e dev
```

#### 方式二：手动创建

```sql
CREATE DATABASE `jiwu-chat-db-dev` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

然后导入 SQL 文件（按顺序）：

- `docker-entrypoint-initdb.d/jiwu-chat-db-dev.sql`
- `docker-entrypoint-initdb.d/*.sql`（changelog 文件）

### 3. 配置文件设置

编辑对应环境的配置文件（如 `jiwu-chat-starter/src/main/resources/application-dev.yml`），主要需要配置以下项：

#### 必须配置项

```yaml
# 服务器端口
server:
  port: 9090

# 数据库连接配置
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/jiwu-chat-db-dev?serverTimezone=GMT%2B8
    username: your_username
    password: your_password
  
  # Redis配置
  redis:
    host: localhost
    port: 6379
    database: 2
  
  # RabbitMQ配置（如使用消息队列功能）
  rabbitmq:
    host: localhost
    port: 5672
    username: your_rabbitmq_username
    password: your_rabbitmq_password
```

#### 可选配置项

```yaml
# 日志级别（开发环境可开启 DEBUG）
logging:
  level:
    com.jiwu.api: debug

# 开发工具配置
spring:
  devtools:
    restart:
      enabled: false
```

#### 其他功能配置（按需）

如需使用以下功能，请在 `application.yml` 中配置：

- **邮件服务**：`spring.mail.*`
- **七牛云 OSS**：`qi-niu-cloud.*`
- **短信服务**：`sms.*`、`uni-sms.*`
- **AI 服务**：`gemini.*`、`kimi.*`、`deepseek.*`、`xunfei.*`；**AI 翻译（SiliconFlow）**：`RES_TRANSLATION_API_URL`、`RES_TRANSLATION_API_KEY`、`RES_TRANSLATION_MODEL`、`RES_TRANSLATION_MAX_TOKENS`
- **腾讯翻译**：`tencent.*`

### 4. 启动项目

#### 方式一：Maven 运行（开发推荐）

```bash
# 编译项目
mvn clean compile

# 运行开发环境（默认 dev profile）
mvn spring-boot:run

# 指定环境运行
mvn spring-boot:run -Dspring-boot.run.profiles=dev
mvn spring-boot:run -Dspring-boot.run.profiles=test
mvn spring-boot:run -Dspring-boot.run.profiles=prod
```

#### 方式二：打包后运行

```bash
# 打包 JAR
mvn clean package -DskipTests

# 运行 JAR
java -jar jiwu-chat-starter/target/jiwu-chat-api.jar --spring.profiles.active=dev
```

#### 方式三：Docker Compose（推荐生产环境）

```bash
# 启动所有服务（MySQL、Redis、RabbitMQ、应用）
docker-compose up -d

# 查看日志
docker-compose logs -f jiwu-chat-api

# 停止服务
docker-compose down
```

### 5. 访问服务

启动成功后，访问以下地址：

- **HTTP API**: <http://localhost:9090>
- **WebSocket**: ws://localhost:9091/ws
- **API 文档**: <http://localhost:9090/doc.html（Knife4j/Swagger）>

## 环境配置

项目支持多环境配置，通过 `spring.profiles.active` 指定：

| 环境 | Profile | 配置文件 |
|------|---------|----------|
| 开发环境 | dev | `application-dev.yml` |
| 测试环境 | test | `application-test.yml` |
| 预发布 | pre | `application-pre.yml` |
| 生产环境 | prod | `application-prod.yml` |

## 常用命令

```bash
# 编译项目
mvn clean compile

# 运行测试
mvn test

# 打包（跳过测试）
mvn clean package -DskipTests

# 查看帮助
./script/init_db_local.sh --help
```

## 注意事项

1. **Java 版本**：必须使用 JDK 21，项目使用了 Java 21 特性
2. **数据库字符集**：确保数据库使用 `utf8mb4` 字符集
3. **端口占用**：确保 9090（HTTP）和 9091（WebSocket）端口未被占用
4. **Redis 连接**：确保 Redis 服务已启动
5. **AI 配置**：如需使用 AI 功能，请在配置文件中配置相应的 API Key

## 故障排查

### 端口被占用

```bash
# 查看端口占用
lsof -i :9090
lsof -i :9091

# 修改端口（编辑 application.yml）
server:
  port: 9090  # 修改为其他端口
```

### 数据库连接失败

- 检查 MySQL 服务是否启动
- 检查数据库用户名密码是否正确
- 检查数据库是否已创建
- 检查防火墙设置

### WebSocket 连接失败

- 检查 9091 端口是否开放
- 检查 Nginx 配置是否支持 WebSocket 协议升级

## 项目结构

```
jiwu-chat-api/
├── jiwu-chat-starter/          # 启动模块（主入口）
├── jiwu-chat-common-core/       # 核心公共模块
├── jiwu-chat-common-data/      # 数据访问层
├── jiwu-chat-module-*/          # 业务模块
├── script/                     # 脚本目录
├── docker-entrypoint-initdb.d/ # 数据库初始化脚本
└── docker-compose.yml          # Docker 编排配置
```

## 更多信息

- 详细文档：查看 [README.md](./README.md)
- API 文档：启动后访问 <http://localhost:9090/doc.html>
- 开发规范：查看 [CLAUDE.md](./CLAUDE.md)
